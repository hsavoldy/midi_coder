/* eslint-disable */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("midiCoder",[],t):"object"==typeof exports?exports.midiCoder=t():e.midiCoder=t()}(this,(()=>(()=>{"use strict";var __webpack_require__={d:(e,t)=>{for(var i in t)__webpack_require__.o(t,i)&&!__webpack_require__.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},__webpack_exports__={};__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Seq:()=>Seq,_:()=>_,abs:()=>abs,addToEditor:()=>addToEditor,bar:()=>bar,beat:()=>beat,beatsPerMeasure:()=>beatsPerMeasure,ccCallbacks:()=>ccCallbacks,ccMap:()=>ccMap,ceil:()=>ceil,changeTempo:()=>changeTempo,checkChannel:()=>checkChannel,checkSeqs:()=>checkSeqs,cos:()=>cos,createTernStatement:()=>createTernStatement,enableLiveCoding:()=>enableLiveCoding,floor:()=>floor,freezeEditor:()=>freezeEditor,getMidiIO:()=>getMidiIO,globalClock:()=>globalClock,handleMidiInput:()=>handleMidiInput,initialCode:()=>initialCode,initializeMidiCoder:()=>initializeMidiCoder,major:()=>major,mapping:()=>mapping,midi:()=>midi,midiClock:()=>midiClock,midiMap:()=>midiMap,midiMsgs:()=>midiMsgs,midi_input_ids:()=>midi_input_ids,midi_input_names:()=>midi_input_names,midi_output_ids:()=>midi_output_ids,midi_output_names:()=>midi_output_names,minor:()=>minor,mute:()=>mute,muted:()=>muted,onBeat:()=>onBeat,onClock:()=>onClock,onMIDIFailure:()=>onMIDIFailure,onMIDISuccess:()=>onMIDISuccess,outputMidiID:()=>outputMidiID,peak:()=>peak,replaceLastLine:()=>replaceLastLine,replaceString:()=>replaceString,reset:()=>reset,round:()=>round,scale:()=>scale,seqsToStart:()=>seqsToStart,seqs_dict:()=>seqs_dict,setMidiClock:()=>setMidiClock,setMidiInput:()=>setMidiInput,setMidiOutput:()=>setMidiOutput,startTern:()=>startTern,stopEverything:()=>stopEverything,stopMap:()=>stopMap,toggleMute:()=>toggleMute,trunc:()=>trunc,unfreezeEditor:()=>unfreezeEditor,unmute:()=>unmute});var globalClock=0,beatsPerMeasure=4,noteOns=null,midiClock=!1,clockWorker=null,tempo=110,mapping=!1,major=[60,62,64,65,67,69,71],minor=[60,62,63,65,67,68,70],scale=major,seqArrays={};function enableLiveCoding(code){code=code.replace("globalThis.",""),code=code.replaceAll("midiMain.","");var lines=code.split("\n");for(var line of lines)if(!line.includes("//")){var inputs=removeArray(line).replace("/","").match(/(\w+)\s*=\s*new\s+Seq\((\w+),?\s*(\w+)?,?\s*\d*\)/);if(inputs){var seqName=inputs[1],notes=isNumber(inputs[2])?null:inputs[2],durs=isNumber(inputs[3])?null:inputs[3];seqArrays[seqName]=[notes,durs]}}code=code.replace("var",""),code=code.replace("let",""),code=code.replace("const","");var assignments=code.match(/(\s+(\w+)\s*=\s*([^;]+))|((\w+)\s*=\s*([^;]+))/g);if(assignments)for(var i=0;i<assignments.length;i++){var assignment=assignments[i].match(/\s*(\w+)\s*=\s*([^;]+)/);if(assignment){var variableName=assignment[1];window[variableName]=eval(assignment[1]),eval(variableName)instanceof Seq&&(seqsToStart[variableName]=eval(variableName),eval(variableName).valsName=seqArrays[variableName][0],eval(variableName).dursName=seqArrays[variableName][1])}}}function initializeMidiCoder(){navigator.requestMIDIAccess().then(onMIDISuccess,onMIDIFailure)}function initialCode(e){return e=(e=e.replaceAll(/\/\*\nMIDI Inputs:\n(\d+.*\n)*MIDI Outputs:\n(\d+.*\n?)*\n\*\/\n*/gi,"")).replaceAll(/midiCoder.setMidiInput\(\d+\);\nmidiCoder.setMidiOutput\(\d+\);\n*/gi,""),null===midi?e:"/*\n"+getMidiIO()+"*/\nmidiCoder.setMidiInput(1);\nmidiCoder.setMidiOutput(1);\n"+e}function setMidiClock(e){midiClock=e}function changeTempo(e){}function changeRow(e){beatsPerMeasure=e,console.log("beats per measure: "+beatsPerMeasure)}function onClock(){if(globalClock%(24*beatsPerMeasure)==0){for(var e in seqsToStart)e in seqs_dict&&seqs_dict[e].stop(),seqs_dict[e]=seqsToStart[e],seqs_dict[e].name=e,seqs_dict[e].start();seqsToStart={}}if(globalClock+=1,checkSeqs(),0!=mapping&globalClock%10==0){console.log("sending");const e=[mapping[0],mapping[1],1];midi.outputs.get(outputMidiID).send(e)}}function onBeat(){if(globalClock%(24*beatsPerMeasure)==0){for(var e in seqsToStart)e in seqs_dict&&seqs_dict[e].stop(),seqs_dict[e]=seqsToStart[e],seqs_dict[e].name=e,seqs_dict[e].start();seqsToStart={}}if(globalClock+=1,checkSeqs(),0!=mapping&globalClock%10==0){console.log("sending");const e=[mapping[0],mapping[1],1];midi.outputs.get(outputMidiID).send(e)}}var seqs=null;function changeTimeSig(e){reset()}var seqsToStart={};function checkStringForNonVariable(e){for(var t=0;t<e.length;t++){if("("==e[t])return!0;if("{"==e[t])return!0;if("\t"==e[t])return!0;if("="==e[t])return!1}return!1}function isNumber(e){return!isNaN(parseInt(e))}function removeArray(e){for(;e.includes("[");)e=e.slice(0,e.indexOf("["))+"0"+e.slice(e.indexOf("]")+1);return e}function addToEditor(e){}function replaceLastLine(e){}function replaceString(e,t){}function freezeEditor(){}function unfreezeEditor(){}var algStage=0,curAlg="",makingIf=!1;function startTern(){makingIf=!0,freezeEditor(),replaceString("startTern()",curAlg="(x")}var opInd=0,valInd=0,parenCount=1,stage=0,ternStage=0,ternSymbols=["?",":"],operators=[">=","<=","==","*","/","+","-"," "],operatorRanges=[15,31,46,72,87,103,118,127],vals=["CC1","CC2","CC3","CC4","CC5","CC6","CC7","CC8","(",")","x"],valRanges=[11,23,34,46,57,69,80,92,103,115,127],numbers=[...Array(25).keys()].map((e=>(e-12).toString()));vals=vals.concat(numbers);var terminate=!1;function createTernStatement(e){var t=curAlg;if(isCC(e))if(stage%2==0){var i=null;for(let t=0;t<valRanges.length;t++)if(e[2]<=valRanges[t]){i=t;break}curAlg=curAlg.slice(0,curAlg.lastIndexOf(vals[a]))+vals[i],a=i}else{var n=null;for(let t=0;t<operatorRanges.length;t++)if(e[2]<=operatorRanges[t]){n=t;break}curAlg=curAlg.slice(0,curAlg.lastIndexOf(operators[s]))+operators[n],s=n}else isNoteOn(e)&&(" "==operators[s]&&ternStage<3&&(curAlg=curAlg.slice(0,curAlg.length-1),2==ternStage?o=!0:(curAlg+=ternSymbols[ternStage],ternStage+=1)),curAlg+=o?")":stage%2==0?" "+operators[0]:" "+vals[0],stage+=1,s=0,a=0);if(replaceString(t,curAlg),o){var s=0,a=0;makingIf=!1;var o=!1}}function startIf(){makingIf=!0,addToEditor("\n"),addToEditor(curAlg="if(x >=")}function createIfStatement(e){var t=e[1],i=(e[0],[">=","<=","=="]);switch(algStage){case 0:if(isNoteOn(e)){if(t>=60){var n=(i.indexOf(curAlg.slice(curAlg.length-2))+1)%i.length;curAlg=curAlg.slice(0,curAlg.length-2)+i[n]}else console.log("elsing"),algStage+=1,curAlg+=" 0){";replaceLastLine(curAlg)}break;case 1:if(isCC(e)){var s=curAlg.indexOf("=")+2,a=e[2];replaceLastLine(curAlg=curAlg.slice(0,s)+a+"){")}else isNoteOn(e)&&(algStage+=1,addToEditor(curAlg="\treturn 0;"));break;case 2:isCC(e)?(s=curAlg.indexOf("n")+2,a=e[2],replaceLastLine(curAlg=curAlg.slice(0,s)+a+";")):isNoteOn(e)&&(addToEditor("}else{"),algStage+=1,addToEditor(curAlg="\treturn 0;"));break;case 3:isCC(e)?(s=curAlg.indexOf("n")+2,a=e[2],replaceLastLine(curAlg=curAlg.slice(0,s)+a+";")):isNoteOn(e)&&(algStage+=1)}}function isNoteOn(e){return e[0]>=144&&e[0]<=159}function isCC(e){return e[0]>=176&&e[0]<=191}var midi=null,muted=!1,outputMidiID=null,midiMsgs={},ccCallbacks={},beat=0;function onMIDISuccess(e){console.log("MIDI ready!"),midi=e}function onMIDIFailure(e){console.error(`Failed to get MIDI access - ${e}`)}var midi_input_ids={},midi_output_ids={},midi_input_names={},midi_output_names={};function getMidiIO(){var e="MIDI Inputs:\n",t="MIDI Outputs:\n",i=null,n=null,s=1;for(var a of midi.outputs)t+=s+": "+a[1].name+"\n",n=a[1].id,midi_output_ids[s]=n,midi_output_names[s]=a[1].name,s+=1;for(var o of(s=1,midi.inputs))e+=s+": "+o[1].name+"\n",i=o[1].id,midi_input_ids[s]=i,midi_input_names[s]=o[1].name,s+=1;return e+t}function setMidiInput(e){for(var t of(Array.isArray(e)||(e=[e]),midi.inputs.forEach((function(e,t){e.onmidimessage=null})),e))t in midi_input_ids&null!=midi.inputs.get(midi_input_ids[t])?(midi.inputs.get(midi_input_ids[t]).onmidimessage=handleMidiInput,console.log("MIDI input set to: "+midi_input_names[t])):console.warn("Invalid input ID")}function setMidiOutput(e){Array.isArray(e)&&console.warn("Can only handle one MIDI output. Please enter one ID."),e in midi_output_ids&null!=midi.outputs.get(midi_output_ids[e])?(outputMidiID=midi_output_ids[e],console.log("MIDI output set to: "+midi_output_names[e])):console.warn("Invalid output ID")}function handleMidiInput(e){if(null!=e.data[1]){let t="note";e.data[0]>>4==11&&(t="cc")}midiClock&&getMIDIClock(e),makingIf?e.data[2]>0&&createTernStatement(e.data):(midiReset(e),handleNote(e),handleCC(e))}function midiReset(e){var t=e.data[0];250==t?(console.log("midi start"),reset()):255==t&&(console.log("midi reset"),reset())}function getMIDIClock(e){248==e.data[0]&&onClock(),globalClock%24==0&&(beat+=1)}function handleCC(message){var command=message.data[0],note=message.data[1],value=message.data.length>2?message.data[2]:0;if(command>=176&command<=191){midiMsgs[note]=value,eval("globalThis.CC"+note+"="+value+";");try{eval("CC"+note+"_func")()}catch{}}}function handleNote(message){var command=message.data[0],note=message.data[1],velocity=message.data.length>2?message.data[2]:0;if(command>=144&command<=159){midiMsgs[note]=velocity;try{eval("midi"+note%12+"_func")()}catch{}for(var key in seqs_dict){var seq=seqs_dict[key];seq.repopulating&&seq.newVals.push(note),seq.inserting&&seq.vals.push(note)}}else command>=128&command<=143&&(midiMsgs[note]=null)}function midiMap(e){mapping=[144,e],muted=!0}function ccMap(e){mapping=[176,e],muted=!0}function stopMap(){const e=[128,mapping[1],0];midi.outputs.get(outputMidiID).send(e),mapping=!1,muted=!1}function mute(){muted=!0}function unmute(){muted=!1}function toggleMute(){muted=!muted}let floor=function(e){return e<-1e5?_:Math.floor(e)},ceil=function(e){return e<-1e5?_:Math.ceil(e)},peak=function(e){return e<-1e5?_:Math.ceil(e)},round=function(e){return e<-1e5?_:Math.round(e)},trunc=function(e){return e<-1e5?_:Math.trunc(e)},abs=function(e){return e<-1e5?_:Math.abs(e)},cos=function(e){return e<-1e5?_:Math.cos(e)};var Oscilloscope=Oscilloscope||function(e,t){var i,n,s;this.target=document.querySelector(e),this.width=this.target.offsetWidth,this.height=this.target.offsetHeight,this.wave=document.createElementNS("http://www.w3.org/2000/svg","path"),this.wave.setAttribute("class","oscilloscope__wave"),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width",this.width),this.svg.setAttribute("height",this.height),this.svg.setAttribute("class","oscilloscope__svg"),this.svg.appendChild(this.wave),this.target.appendChild(this.svg),this.audioContext=t||new window.AudioContext,this.running=!1,this.hasAudio=!1,this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=128,n=this.analyserNode.frequencyBinCount,s=new Uint8Array(n),i=function(){var e="M";this.analyserNode.getByteTimeDomainData(s),s.forEach(function(t,i){e+=(this.width+this.width/n)/n*i+" "+this.height/2*(t/128)+", "}.bind(this)),this.wave.setAttribute("d",e),this.running&&window.requestAnimationFrame(i)}.bind(this),this.start=function(){this.running=!0,window.requestAnimationFrame(i)}.bind(this)};Oscilloscope.prototype.stop=function(){this.running=!1},Oscilloscope.prototype.connect=function(e){this.analyserNode.connect(e)},Oscilloscope.prototype.toggleAudio=function(){this.hasAudio?this.analyserNode.disconnect():this.analyserNode.connect(this.audioContext.destination),this.hasAudio=!this.hasAudio};var bar=0,column=null,divID="display-box",seqs_dict={},_=-999999999;function checkSeqs(){for(var e in seqs_dict){var t=seqs_dict[e];t.timeForNext()&&(t.callback(),t.executeStep()),t.restarted&&(seqsToStart[e]=t,t.restarted=!1)}}function reset(){for(var e in seqs_dict)seqs_dict[e].reset();globalClock=0}function checkChannel(e){return e>16?(console.warn("Cannot have a channel larger than 16. Using channel 1."),e=1):e<=0&&(e=1),e}function stopEverything(){for(let e in seqs_dict)seqs_dict[e].stop();seqs_dict={}}var seqs_dict={};class Seq{constructor(e,t=1/4,i=0){this.vals=e,this.durs=t,this.noteInd=0,this.dursInd=0,this.noteInc=1,this.dursInc=1,this.repopulating=!1,this.inserting=!1,this.stopped=!1,this.nextValTime=globalClock,this.channel=i,this.velocity=127,this.controllerNum=7,this.restarted=!1,this.monitor=!1,this.newVals=[],this.lastNoteSent=null,i>16&&(console.warn("Cannot have a channel larger than 16. Setting channel to 1."),this.channel=1),this.stepFunc=this.sendNote,this.name="",this.octave=0,this.valsName=null,this.dursName=null,this.curVal=null}executeStep(){this.updateArrays(),this.advanceStep()}advanceStep(){this.curVal=this.nextVal(),this.curVal=this.transform(this.curVal),null!=this.curVal&&(muted||(this.channel=checkChannel(this.channel),this.stepFunc()))}sendNoteOff(e){if(null==e|e<0)return;const t=[128+checkChannel(this.channel)-1,e,0];midi.outputs.get(outputMidiID).send(t)}transform(e){return e}sendNote(){if(muted)return;var e,t=this.curVal;if(t>-9e8&&t<-7e6)return;if(this.sendNoteOff(this.lastNoteSent,this.channel),null!=scale){var i=!1,n=t;10*t%10!=0&&(n=Math.floor(Math.abs(t))*t/Math.abs(t),i=!0),e=scale.slice(n%scale.length)[0]+12*Math.floor(n/scale.length)+12*this.octave,i&&(t>0?e+=1:e-=1)}else e=t;if(e<0||null==e||e>127)return;const s=[144+this.channel-1,e,this.velocity];midi.outputs.get(outputMidiID).send(s),this.lastNoteSent=e;Math.floor(globalClock/(24*beatsPerMeasure));Math.floor(globalClock/24),this.monitor&&console.log(this.name+" midi: "+e," vel: "+this.velocity)}sendCC(){const e=[176+this.channel-1,this.controllerNum,this.curVal];muted||(midi.outputs.get(outputMidiID).send(e),console.log(e))}timeForNext(){return!this.stopped&&this.nextValTime<=globalClock}nextVal(){if(0===this.vals.length)return this.noteInd=0,null;var e=this.vals[floor(this.noteInd)];this.updateNoteIndex(),this.noteInd=this.noteInd%this.vals.length;var t;return t="number"!=typeof this.durs?this.durs[floor(this.dursInd)]:this.durs,this.nextValTime=globalClock+24*t*4,this.updateDurIndex(),"number"!=typeof this.durs&&(this.dursInd=this.dursInd%this.durs.length),e}updateNoteIndex(){this.noteInd=this.noteInd+this.noteInc}updateDurIndex(){this.dursInd=this.dursInd+this.dursInc}repopulate(){this.newVals=[],this.repopulating=!0}stopPop(){this.noteInd>=this.newVals.length&&(this.noteInd=this.newVals.length-1),this.vals=this.newVals,this.repopulating=!1}appendNote(e){this.vals.push(e)}stop(){this.stopped=!0,this.sendNoteOff(this.lastNoteSent,this.channel)}start(){this.stopped=!1}reset(){this.noteInd=0,this.dursInd=0,this.nextValTime=0,this.sendNoteOff(this.lastNoteSent,this.channel),this.restarted=!0,this.stop()}addFunction(e){this.callback=e}callback(){}updateArrays(){if(this.valsName){var newVals=eval("globalThis."+this.valsName);this.noteInd=this.noteInd%newVals.length,this.vals=newVals}if(this.dursName){var newDurs=eval("globalThis."+this.dursName);Array.isArray(newDurs)&&(this.dursInd=this.dursInd%newDurs.length),this.durs=newDurs}}}return __webpack_exports__})()));